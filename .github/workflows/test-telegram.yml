name: Test Telegram Notification

on:
  workflow_dispatch: # Manual trigger only

jobs:
  test-notification:
    name: Test Telegram Notification
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create dummy training images
        run: |
          # Create some dummy PNG files to simulate training outputs
          echo "Creating test images..."
          convert -size 800x600 xc:blue -pointsize 40 -fill white -gravity center \
            -annotate +0+0 "Goal Achievement - Vanilla PPO\nTest Image" \
            goal_achievement_VANILLA_PPO.png || echo "ImageMagick not available, creating placeholder"
          
          # Fallback: create simple text files if ImageMagick not available
          if [ ! -f "goal_achievement_VANILLA_PPO.png" ]; then
            echo "Test Image 1" > goal_achievement_VANILLA_PPO.png
            echo "Test Image 2" > goal_achievement_AR_PPO.png
            echo "Test Image 3" > rdr_rules_usage_NS.png
          fi
          
          ls -lh *.png

      - name: Send Telegram notification
        if: always()
        run: |
          STATUS_EMOJI="âœ…"
          STATUS_TEXT="TEST SUCCESS"
          
          MESSAGE="${STATUS_EMOJI} *UAV Training Job ${STATUS_TEXT}*%0A%0A"
          MESSAGE+="Repository: ${{ github.repository }}%0A"
          MESSAGE+="Workflow: ${{ github.workflow }}%0A"
          MESSAGE+="Job: Test Telegram Notification%0A"
          MESSAGE+="Run: ${{ github.run_number }}%0A"
          MESSAGE+="Commit: ${{ github.sha }}%0A"
          MESSAGE+="Branch: ${{ github.ref_name }}%0A"
          MESSAGE+="Triggered by: ${{ github.event_name }}%0A%0A"
          MESSAGE+="[View Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          # Send text message
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TG_CHAT_ID }}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true
          
          # Send training images if they exist
          for png_file in *.png; do
            if [ -f "$png_file" ]; then
              echo "ðŸ“¸ Sending image: $png_file"
              curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendPhoto" \
                -F chat_id="${{ secrets.TG_CHAT_ID }}" \
                -F photo=@"$png_file" \
                -F caption="Training Result: $png_file"
            fi
          done
          
          echo "âœ… Test notification sent successfully!"